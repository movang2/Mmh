<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Há»c tá»« vá»±ng Tá»± Äá»™ng</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“˜</text></svg>">
<style>
  /* --- CSS GIAO DIá»†N --- */
  body { background: #121212; color: #e0e0e0; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; margin: 0; }
  h2 { color: #64b5f6; margin-bottom: 10px; }
  #clock { font-size: 3.5em; font-weight: bold; margin-top: 10px; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
  #date { font-size: 1.1em; color: #aaa; margin-bottom: 20px; }
  #displayArea { width: 90%; max-width: 800px; text-align: center; font-size: 1.6em; line-height: 1.6; margin: 10px 0; padding: 20px; background: #1e1e1e; border-radius: 15px; border: 1px solid #333; min-height: 100px; white-space: pre-wrap; display: flex; align-items: center; justify-content: center; flex-direction: column; font-weight: 500;}
  #controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; width: 100%; max-width: 800px; }
  button, input, .setting-group { padding: 10px; border-radius: 8px; border: none; font-size: 14px; }
  button { background: #424242; color: white; cursor: pointer; border: 1px solid #555; }
  #startBtn { background: #2e7d32; font-weight: bold;}
  #pushNotificationBtn { background: linear-gradient(135deg, #1565c0, #6a1b9a); color: white; font-weight: bold; }
  #pushNotificationBtn.active { background: linear-gradient(135deg, #2e7d32, #43a047); }
  .setting-group { background: #252525; display: flex; align-items: center; gap: 5px; color: #bbb; }
  input[type="number"] { background: #333; color: white; border: 1px solid #444; width: 50px; text-align: center;}
  #bubble { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: #0288d1; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; z-index: 9999; user-select: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
  #scrollSlider { width: 90%; margin-top: 20px; accent-color: #0288d1; }
  .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.95); padding: 12px 24px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; border: 1px solid #555; z-index: 10000; font-weight: bold;}
  .toast.show { opacity: 1; }
</style>
</head>
<body>
  <div id="clock">00:00</div>
  <div id="date">--/--/----</div>
  <h2 id="appTitle">ğŸ“˜ Há»c tá»« vá»±ng TXT</h2>
  
  <div id="displayArea">
    <div style="opacity: 0.7">ğŸ“‚ Chá»n file .txt Ä‘á»ƒ báº¯t Ä‘áº§u</div>
  </div>
  
  <div id="wordInfo" style="display:none; color:#888; margin-bottom: 5px;">0/0</div>
  <input type="range" min="0" max="100" value="0" id="scrollSlider" disabled>

  <div id="controls">
    <input type="file" id="fileInput" accept=".txt">
    <button id="startBtn">â–¶ï¸ Báº¯t Ä‘áº§u</button>
    <button onclick="clearProgress()">ğŸ—‘ï¸ Reset</button>
    <button id="pushNotificationBtn">ğŸ”” Báº­t thÃ´ng bÃ¡o</button>
    <div class="setting-group">â±ï¸ <input type="number" id="timePerGroup" value="5">s</div>
    <div class="setting-group">ğŸ“š <input type="number" id="wordCount" value="5">tá»«</div>
    <div class="setting-group">ğŸ”¤ <input type="range" min="1" max="5" value="1.5" step="0.1" id="fontSize"></div>
  </div>
  
  <div id="bubble">â¸ï¸</div>
  <div id="toast" class="toast">ThÃ´ng bÃ¡o</div>

<script>
// ========== KHAI BÃO BIáº¾N ==========
let words = [], currentIndex = 0, intervalTimer, isRunning = false, pushEnabled = false;
const els = { 
    clock: document.getElementById('clock'), date: document.getElementById('date'), 
    display: document.getElementById('displayArea'), slider: document.getElementById('scrollSlider'), 
    fileInput: document.getElementById('fileInput'), controls: document.getElementById('controls'), 
    bubble: document.getElementById('bubble'), wordInfo: document.getElementById('wordInfo'), 
    notifBtn: document.getElementById('pushNotificationBtn'), toast: document.getElementById('toast') 
};

// ========== LOGIC Äá»’NG Há»’ ==========
setInterval(() => { 
    const now = new Date(); 
    els.clock.textContent = now.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}); 
    els.date.textContent = now.toLocaleDateString('vi-VN',{weekday:'short',day:'2-digit',month:'long'}); 
}, 1000);

// ========== Xá»¬ LÃ FILE TXT ==========
els.fileInput.addEventListener('change', e => {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => { 
    words = ev.target.result.split(/[,;\n]+/).map(w=>w.trim()).filter(w=>w); 
    if(words.length){ 
        els.display.innerHTML=`âœ… ÄÃ£ táº£i <b>${words.length}</b> tá»«. Vui lÃ²ng nháº¥n Báº®T Äáº¦U.`; 
        els.slider.disabled=false; 
        els.slider.max=words.length-1; 
        saveState(); 
        showToast(`ÄÃ£ táº£i ${words.length} tá»«`); 
    }
  };
  reader.readAsText(file);
});

// ========== Báº®T Äáº¦U/Dá»ªNG Há»ŒC ==========
document.getElementById('startBtn').addEventListener('click', startLearning);
els.bubble.addEventListener('click', stopLearning);

function startLearning() {
  if(!words.length) return showToast('âš ï¸ ChÆ°a cÃ³ file!');
  
  isRunning = true; 
  els.controls.style.display='none'; 
  document.getElementById('appTitle').style.display='none'; 
  els.fileInput.style.display='none'; 
  els.bubble.style.display='flex'; 
  els.wordInfo.style.display='block';
  
  const count = parseInt(document.getElementById('wordCount').value)||5;
  // Láº¥y giÃ¡ trá»‹ tá»« input, máº·c Ä‘á»‹nh 5s
  const time = (parseInt(document.getElementById('timePerGroup').value)||5)*1000; 
  
  const show = () => {
    if(currentIndex >= words.length) { stopLearning(); return showToast('ğŸ‰ HoÃ n thÃ nh!'); }
    
    // 1. Láº¥y nhÃ³m tá»« hiá»‡n táº¡i
    const chunk = words.slice(currentIndex, currentIndex+count);
    
    // 2. Hiá»ƒn thá»‹ lÃªn mÃ n hÃ¬nh web
    els.display.innerText = chunk.map((w,i)=>`${currentIndex+i+1}. ${w}`).join('\n\n'); 
    els.slider.value = currentIndex; 
    els.wordInfo.innerText = `${currentIndex+1} - ${Math.min(currentIndex+count, words.length)} / ${words.length}`;
    
    // 3. Gá»¬I THÃ”NG BÃO (ÄÃƒ Sá»¬A VÃ€ Tá»I Æ¯U HÆ N)
    if(pushEnabled) {
        // DÃ¹ng \n vÃ  â€¢ Ä‘á»ƒ hiá»ƒn thá»‹ thÃ nh danh sÃ¡ch khi thÃ´ng bÃ¡o Ä‘Æ°á»£c má»Ÿ rá»™ng
        const wordList = chunk.map(w => "â€¢ " + w).join('\n'); 
        const title = `ğŸ“– Há»c: ${currentIndex+1} - ${currentIndex + chunk.length} / ${words.length}`;
        sendNotification(title, wordList);
    }
    
    currentIndex += count; 
    saveState();
  };
  
  show(); 
  intervalTimer = setInterval(show, time);
  
  if(pushEnabled) sendNotification('ğŸš€ Báº¯t Ä‘áº§u', 'Tá»« vá»±ng sáº½ hiá»‡n trÃªn thÃ´ng bÃ¡o!');
}

function stopLearning() {
  isRunning=false; clearInterval(intervalTimer); 
  els.controls.style.display='flex'; 
  document.getElementById('appTitle').style.display='block'; 
  els.fileInput.style.display='block'; 
  els.bubble.style.display='none'; 
  els.display.innerHTML=`â¸ï¸ <b>Táº¡m dá»«ng</b><br>Tiáº¿p tá»¥c tá»« vá»‹ trÃ­: ${currentIndex}`; 
  saveState();
}

// ========== CÃ€I Äáº¶T VÃ€ TRáº NG THÃI ==========
els.slider.addEventListener('input', e => { 
    currentIndex=parseInt(e.target.value); 
    els.wordInfo.innerText=`${currentIndex}/${words.length}`; 
    if(!isRunning) els.display.innerText=`${currentIndex}: ${words[currentIndex]||''}`; 
    saveState();
});

document.getElementById('fontSize').addEventListener('input', e => {
    els.display.style.fontSize=e.target.value+'em'; 
    saveState();
});

document.getElementById('wordCount').addEventListener('input', saveState);
document.getElementById('timePerGroup').addEventListener('input', saveState);

// ========== LOGIC PUSH NOTIFICATION ==========
els.notifBtn.addEventListener('click', async () => {
  if (!('serviceWorker' in navigator) || !('Notification' in window)) return alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ thÃ´ng bÃ¡o.");
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') return showToast('âŒ Cáº§n cáº¥p quyá»n thÃ´ng bÃ¡o');

  try {
    // ÄÄƒng kÃ½ file sw.js
    await navigator.serviceWorker.register('sw.js');
    pushEnabled = true;
    els.notifBtn.innerHTML = "ğŸ”” ÄÃ£ báº­t (Äang cháº¡y)"; 
    els.notifBtn.classList.add('active');
    showToast("âœ… ÄÃ£ báº­t thÃ´ng bÃ¡o!");
    sendNotification("ğŸ”” Test ThÃ nh cÃ´ng", "Tá»« vá»±ng sáº½ hiá»‡n rÃµ rÃ ng á»Ÿ Ä‘Ã¢y!");
  } catch (err) {
    alert("Lá»—i Ä‘Äƒng kÃ½ Service Worker: " + err.message + "\n\nHÃ£y cháº¯c cháº¯n file sw.js Ä‘Ã£ Ä‘Æ°á»£c táº£i lÃªn cÃ¹ng thÆ° má»¥c.");
  }
});

function sendNotification(title, body) {
  if (!pushEnabled) return;
  const icon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ“˜%3C/text%3E%3C/svg%3E";
  
  navigator.serviceWorker.ready.then(reg => {
      reg.showNotification(title, { 
          body: body, 
          icon: icon, 
          tag: 'vocab-app', // Ghi Ä‘Ã¨ thÃ´ng bÃ¡o cÅ©
          renotify: true, // Rung láº¡i khi cÃ³ tá»« má»›i
          vibrate: [100, 50, 100],
          silent: false 
      });
  });
}

// ========== TIá»†N ÃCH CHUNG ==========
function showToast(msg) { 
    els.toast.textContent=msg; 
    els.toast.classList.add('show'); 
    setTimeout(()=>els.toast.classList.remove('show'),3000); 
}

function saveState() { 
    localStorage.setItem('vocabState', JSON.stringify({
        words, currentIndex, 
        settings:{
            fontSize:document.getElementById('fontSize').value, 
            count:document.getElementById('wordCount').value, 
            time:document.getElementById('timePerGroup').value
        }
    })); 
}

function loadState() { 
    const raw = localStorage.getItem('vocabState');
    if(raw) {
        const d = JSON.parse(raw); 
        if(d?.words?.length) { 
            words=d.words; currentIndex=d.currentIndex||0; 
            els.slider.max=words.length-1; 
            els.slider.disabled=false;
            els.display.innerHTML=`ğŸ“‚ ÄÃ£ khÃ´i phá»¥c phiÃªn trÆ°á»›c.<br>Vá»‹ trÃ­: <b>${currentIndex}</b> / ${words.length}`; 
        } 
        if (d?.settings) {
            document.getElementById('fontSize').value = d.settings.fontSize || 1.5;
            els.display.style.fontSize = (d.settings.fontSize || 1.5) + 'em';
            document.getElementById('wordCount').value = d.settings.count || 5;
            document.getElementById('timePerGroup').value = d.settings.time || 5;
        }
    }
}

function clearProgress() { 
    if(confirm("XÃ³a toÃ n bá»™ dá»¯ liá»‡u há»c vÃ  cÃ i Ä‘áº·t?")) { 
        localStorage.removeItem('vocabState'); 
        location.reload(); 
    } 
}

// Drag bubble (mousedown for desktop, touchstart for mobile)
let isDragging = false;
const dragLogic = (e) => {
    isDragging = false; 
    e.preventDefault();
    const isTouch = e.type.startsWith('touch');
    const client = isTouch ? e.touches[0] : e;
    
    const off = {
        x: client.clientX - els.bubble.getBoundingClientRect().left, 
        y: client.clientY - els.bubble.getBoundingClientRect().top
    };
    
    const move = (ev) => {
        isDragging = true; 
        const currentClient = isTouch ? ev.touches[0] : ev;
        els.bubble.style.left = (currentClient.clientX - off.x) + 'px'; 
        els.bubble.style.top = (currentClient.clientY - off.y) + 'px';
        els.bubble.style.right = 'auto'; 
        els.bubble.style.bottom = 'auto';
        if (isTouch) ev.preventDefault();
    };

    const end = () => {
        const eventType = isTouch ? 'touchmove' : 'mousemove';
        document.removeEventListener(eventType, move);
        if(isDragging){
            // Táº¯t click táº¡m thá»i khi kÃ©o
            const oldClick = els.bubble.onclick;
            els.bubble.onclick = null;
            setTimeout(() => els.bubble.onclick = oldClick, 100);
        }
    };
    
    const eventType = isTouch ? 'touchmove' : 'mousemove';
    document.addEventListener(eventType, move, { passive: !isTouch });
    document.addEventListener(isTouch ? 'touchend' : 'mouseup', end, { once: true });
};

els.bubble.addEventListener('mousedown', dragLogic);
els.bubble.addEventListener('touchstart', dragLogic);


// ========== KHá»I Táº O ==========
window.addEventListener('load', () => {
    loadState();
    // Tá»± Ä‘á»™ng scroll nháº¹ Ä‘á»ƒ áº©n thanh Ä‘á»‹a chá»‰ trÃªn mobile
    setTimeout(() => window.scrollTo(0, 1), 100);
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Há»c tá»« vá»±ng Tá»± Äá»™ng</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“˜</text></svg>">
<style>
  /* --- CSS GIAO DIá»†N --- */
  body { background: #121212; color: #e0e0e0; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; margin: 0; }
  h2 { color: #64b5f6; margin-bottom: 10px; }
  #clock { font-size: 3.5em; font-weight: bold; margin-top: 10px; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
  #date { font-size: 1.1em; color: #aaa; margin-bottom: 20px; }
  #displayArea { width: 90%; max-width: 800px; text-align: center; font-size: 1.6em; line-height: 1.6; margin: 10px 0; padding: 20px; background: #1e1e1e; border-radius: 15px; border: 1px solid #333; min-height: 100px; white-space: pre-wrap; display: flex; align-items: center; justify-content: center; flex-direction: column; font-weight: 500;}
  #controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; width: 100%; max-width: 800px; }
  button, input, .setting-group { padding: 10px; border-radius: 8px; border: none; font-size: 14px; }
  button { background: #424242; color: white; cursor: pointer; border: 1px solid #555; }
  #startBtn { background: #2e7d32; font-weight: bold;}
  #pushNotificationBtn { background: linear-gradient(135deg, #1565c0, #6a1b9a); color: white; font-weight: bold; }
  #pushNotificationBtn.active { background: linear-gradient(135deg, #2e7d32, #43a047); }
  .setting-group { background: #252525; display: flex; align-items: center; gap: 5px; color: #bbb; }
  input[type="number"] { background: #333; color: white; border: 1px solid #444; width: 50px; text-align: center;}
  #bubble { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: #0288d1; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; z-index: 9999; user-select: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
  #scrollSlider { width: 90%; margin-top: 20px; accent-color: #0288d1; }
  .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.95); padding: 12px 24px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; border: 1px solid #555; z-index: 10000; font-weight: bold;}
  .toast.show { opacity: 1; }
</style>
</head>
<body>
  <div id="clock">00:00</div>
  <div id="date">--/--/----</div>
  <h2 id="appTitle">ğŸ“˜ Há»c tá»« vá»±ng TXT</h2>
  
  <div id="displayArea">
    <div style="opacity: 0.7">ğŸ“‚ Chá»n file .txt Ä‘á»ƒ báº¯t Ä‘áº§u</div>
  </div>
  
  <div id="wordInfo" style="display:none; color:#888; margin-bottom: 5px;">0/0</div>
  <input type="range" min="0" max="100" value="0" id="scrollSlider" disabled>

  <div id="controls">
    <input type="file" id="fileInput" accept=".txt">
    <button id="startBtn">â–¶ï¸ Báº¯t Ä‘áº§u</button>
    <button onclick="clearProgress()">ğŸ—‘ï¸ Reset</button>
    <button id="pushNotificationBtn">ğŸ”” Báº­t thÃ´ng bÃ¡o</button>
    <div class="setting-group">â±ï¸ <input type="number" id="timePerGroup" value="5">s</div>
    <div class="setting-group">ğŸ“š <input type="number" id="wordCount" value="5">tá»«</div>
    <div class="setting-group">ğŸ”¤ <input type="range" min="1" max="5" value="1.5" step="0.1" id="fontSize"></div>
  </div>
  
  <div id="bubble">â¸ï¸</div>
  <div id="toast" class="toast">ThÃ´ng bÃ¡o</div>

<script>
// ========== KHAI BÃO BIáº¾N ==========
let words = [], currentIndex = 0, intervalTimer, isRunning = false, pushEnabled = false;
const els = { 
    clock: document.getElementById('clock'), date: document.getElementById('date'), 
    display: document.getElementById('displayArea'), slider: document.getElementById('scrollSlider'), 
    fileInput: document.getElementById('fileInput'), controls: document.getElementById('controls'), 
    bubble: document.getElementById('bubble'), wordInfo: document.getElementById('wordInfo'), 
    notifBtn: document.getElementById('pushNotificationBtn'), toast: document.getElementById('toast') 
};

// ========== LOGIC Äá»’NG Há»’ ==========
setInterval(() => { 
    const now = new Date(); 
    els.clock.textContent = now.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}); 
    els.date.textContent = now.toLocaleDateString('vi-VN',{weekday:'short',day:'2-digit',month:'long'}); 
}, 1000);

// ========== Xá»¬ LÃ FILE TXT ==========
els.fileInput.addEventListener('change', e => {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => { 
    words = ev.target.result.split(/[,;\n]+/).map(w=>w.trim()).filter(w=>w); 
    if(words.length){ 
        els.display.innerHTML=`âœ… ÄÃ£ táº£i <b>${words.length}</b> tá»«. Vui lÃ²ng nháº¥n Báº®T Äáº¦U.`; 
        els.slider.disabled=false; 
        els.slider.max=words.length-1; 
        saveState(); 
        showToast(`ÄÃ£ táº£i ${words.length} tá»«`); 
    }
  };
  reader.readAsText(file);
});

// ========== Báº®T Äáº¦U/Dá»ªNG Há»ŒC ==========
document.getElementById('startBtn').addEventListener('click', startLearning);
els.bubble.addEventListener('click', stopLearning);

function startLearning() {
  if(!words.length) return showToast('âš ï¸ ChÆ°a cÃ³ file!');
  
  isRunning = true; 
  els.controls.style.display='none'; 
  document.getElementById('appTitle').style.display='none'; 
  els.fileInput.style.display='none'; 
  els.bubble.style.display='flex'; 
  els.wordInfo.style.display='block';
  
  const count = parseInt(document.getElementById('wordCount').value)||5;
  // Láº¥y giÃ¡ trá»‹ tá»« input, máº·c Ä‘á»‹nh 5s
  const time = (parseInt(document.getElementById('timePerGroup').value)||5)*1000; 
  
  const show = () => {
    if(currentIndex >= words.length) { stopLearning(); return showToast('ğŸ‰ HoÃ n thÃ nh!'); }
    
    // 1. Láº¥y nhÃ³m tá»« hiá»‡n táº¡i
    const chunk = words.slice(currentIndex, currentIndex+count);
    
    // 2. Hiá»ƒn thá»‹ lÃªn mÃ n hÃ¬nh web
    els.display.innerText = chunk.map((w,i)=>`${currentIndex+i+1}. ${w}`).join('\n\n'); 
    els.slider.value = currentIndex; 
    els.wordInfo.innerText = `${currentIndex+1} - ${Math.min(currentIndex+count, words.length)} / ${words.length}`;
    
    // 3. Gá»¬I THÃ”NG BÃO (ÄÃƒ Sá»¬A VÃ€ Tá»I Æ¯U HÆ N)
    if(pushEnabled) {
        // DÃ¹ng \n vÃ  â€¢ Ä‘á»ƒ hiá»ƒn thá»‹ thÃ nh danh sÃ¡ch khi thÃ´ng bÃ¡o Ä‘Æ°á»£c má»Ÿ rá»™ng
        const wordList = chunk.map(w => "â€¢ " + w).join('\n'); 
        const title = `ğŸ“– Há»c: ${currentIndex+1} - ${currentIndex + chunk.length} / ${words.length}`;
        sendNotification(title, wordList);
    }
    
    currentIndex += count; 
    saveState();
  };
  
  show(); 
  intervalTimer = setInterval(show, time);
  
  if(pushEnabled) sendNotification('ğŸš€ Báº¯t Ä‘áº§u', 'Tá»« vá»±ng sáº½ hiá»‡n trÃªn thÃ´ng bÃ¡o!');
}

function stopLearning() {
  isRunning=false; clearInterval(intervalTimer); 
  els.controls.style.display='flex'; 
  document.getElementById('appTitle').style.display='block'; 
  els.fileInput.style.display='block'; 
  els.bubble.style.display='none'; 
  els.display.innerHTML=`â¸ï¸ <b>Táº¡m dá»«ng</b><br>Tiáº¿p tá»¥c tá»« vá»‹ trÃ­: ${currentIndex}`; 
  saveState();
}

// ========== CÃ€I Äáº¶T VÃ€ TRáº NG THÃI ==========
els.slider.addEventListener('input', e => { 
    currentIndex=parseInt(e.target.value); 
    els.wordInfo.innerText=`${currentIndex}/${words.length}`; 
    if(!isRunning) els.display.innerText=`${currentIndex}: ${words[currentIndex]||''}`; 
    saveState();
});

document.getElementById('fontSize').addEventListener('input', e => {
    els.display.style.fontSize=e.target.value+'em'; 
    saveState();
});

document.getElementById('wordCount').addEventListener('input', saveState);
document.getElementById('timePerGroup').addEventListener('input', saveState);

// ========== LOGIC PUSH NOTIFICATION ==========
els.notifBtn.addEventListener('click', async () => {
  if (!('serviceWorker' in navigator) || !('Notification' in window)) return alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ thÃ´ng bÃ¡o.");
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') return showToast('âŒ Cáº§n cáº¥p quyá»n thÃ´ng bÃ¡o');

  try {
    // ÄÄƒng kÃ½ file sw.js
    await navigator.serviceWorker.register('sw.js');
    pushEnabled = true;
    els.notifBtn.innerHTML = "ğŸ”” ÄÃ£ báº­t (Äang cháº¡y)"; 
    els.notifBtn.classList.add('active');
    showToast("âœ… ÄÃ£ báº­t thÃ´ng bÃ¡o!");
    sendNotification("ğŸ”” Test ThÃ nh cÃ´ng", "Tá»« vá»±ng sáº½ hiá»‡n rÃµ rÃ ng á»Ÿ Ä‘Ã¢y!");
  } catch (err) {
    alert("Lá»—i Ä‘Äƒng kÃ½ Service Worker: " + err.message + "\n\nHÃ£y cháº¯c cháº¯n file sw.js Ä‘Ã£ Ä‘Æ°á»£c táº£i lÃªn cÃ¹ng thÆ° má»¥c.");
  }
});

function sendNotification(title, body) {
  if (!pushEnabled) return;
  const icon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ“˜%3C/text%3E%3C/svg%3E";
  
  navigator.serviceWorker.ready.then(reg => {
      reg.showNotification(title, { 
          body: body, 
          icon: icon, 
          tag: 'vocab-app', // Ghi Ä‘Ã¨ thÃ´ng bÃ¡o cÅ©
          renotify: true, // Rung láº¡i khi cÃ³ tá»« má»›i
          vibrate: [100, 50, 100],
          silent: false 
      });
  });
}

// ========== TIá»†N ÃCH CHUNG ==========
function showToast(msg) { 
    els.toast.textContent=msg; 
    els.toast.classList.add('show'); 
    setTimeout(()=>els.toast.classList.remove('show'),3000); 
}

function saveState() { 
    localStorage.setItem('vocabState', JSON.stringify({
        words, currentIndex, 
        settings:{
            fontSize:document.getElementById('fontSize').value, 
            count:document.getElementById('wordCount').value, 
            time:document.getElementById('timePerGroup').value
        }
    })); 
}

function loadState() { 
    const raw = localStorage.getItem('vocabState');
    if(raw) {
        const d = JSON.parse(raw); 
        if(d?.words?.length) { 
            words=d.words; currentIndex=d.currentIndex||0; 
            els.slider.max=words.length-1; 
            els.slider.disabled=false;
            els.display.innerHTML=`ğŸ“‚ ÄÃ£ khÃ´i phá»¥c phiÃªn trÆ°á»›c.<br>Vá»‹ trÃ­: <b>${currentIndex}</b> / ${words.length}`; 
        } 
        if (d?.settings) {
            document.getElementById('fontSize').value = d.settings.fontSize || 1.5;
            els.display.style.fontSize = (d.settings.fontSize || 1.5) + 'em';
            document.getElementById('wordCount').value = d.settings.count || 5;
            document.getElementById('timePerGroup').value = d.settings.time || 5;
        }
    }
}

function clearProgress() { 
    if(confirm("XÃ³a toÃ n bá»™ dá»¯ liá»‡u há»c vÃ  cÃ i Ä‘áº·t?")) { 
        localStorage.removeItem('vocabState'); 
        location.reload(); 
    } 
}

// Drag bubble (mousedown for desktop, touchstart for mobile)
let isDragging = false;
const dragLogic = (e) => {
    isDragging = false; 
    e.preventDefault();
    const isTouch = e.type.startsWith('touch');
    const client = isTouch ? e.touches[0] : e;
    
    const off = {
        x: client.clientX - els.bubble.getBoundingClientRect().left, 
        y: client.clientY - els.bubble.getBoundingClientRect().top
    };
    
    const move = (ev) => {
        isDragging = true; 
        const currentClient = isTouch ? ev.touches[0] : ev;
        els.bubble.style.left = (currentClient.clientX - off.x) + 'px'; 
        els.bubble.style.top = (currentClient.clientY - off.y) + 'px';
        els.bubble.style.right = 'auto'; 
        els.bubble.style.bottom = 'auto';
        if (isTouch) ev.preventDefault();
    };

    const end = () => {
        const eventType = isTouch ? 'touchmove' : 'mousemove';
        document.removeEventListener(eventType, move);
        if(isDragging){
            // Táº¯t click táº¡m thá»i khi kÃ©o
            const oldClick = els.bubble.onclick;
            els.bubble.onclick = null;
            setTimeout(() => els.bubble.onclick = oldClick, 100);
        }
    };
    
    const eventType = isTouch ? 'touchmove' : 'mousemove';
    document.addEventListener(eventType, move, { passive: !isTouch });
    document.addEventListener(isTouch ? 'touchend' : 'mouseup', end, { once: true });
};

els.bubble.addEventListener('mousedown', dragLogic);
els.bubble.addEventListener('touchstart', dragLogic);


// ========== KHá»I Táº O ==========
window.addEventListener('load', () => {
    loadState();
    // Tá»± Ä‘á»™ng scroll nháº¹ Ä‘á»ƒ áº©n thanh Ä‘á»‹a chá»‰ trÃªn mobile
    setTimeout(() => window.scrollTo(0, 1), 100);
});
</script>
</body>
</html>
