<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Há»c tá»« vá»±ng Tá»± Äá»™ng</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“˜</text></svg>">
<style>
  /* --- CSS GIAO DIá»†N --- */
  body { background: #121212; color: #e0e0e0; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; margin: 0; }
  h2 { color: #64b5f6; margin-bottom: 10px; }
  #clock { font-size: 3.5em; font-weight: bold; margin-top: 10px; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
  #date { font-size: 1.1em; color: #aaa; margin-bottom: 20px; }
  #displayArea { width: 90%; max-width: 800px; text-align: center; font-size: 1.6em; line-height: 1.6; margin: 10px 0; padding: 20px; background: #1e1e1e; border-radius: 15px; border: 1px solid #333; min-height: 100px; white-space: pre-wrap; display: flex; align-items: center; justify-content: center; flex-direction: column; font-weight: 500;}
  #controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; width: 100%; max-width: 800px; }
  button, input, .setting-group, textarea { padding: 10px; border-radius: 8px; border: none; font-size: 14px; }
  button { background: #424242; color: white; cursor: pointer; border: 1px solid #555; }
  #startBtn { background: #2e7d32; font-weight: bold;}
  #pushNotificationBtn { background: linear-gradient(135deg, #1565c0, #6a1b9a); color: white; font-weight: bold; }
  #pushNotificationBtn.active { background: linear-gradient(135deg, #2e7d32, #43a047); }
  .setting-group { background: #252525; display: flex; align-items: center; gap: 5px; color: #bbb; }
  input[type="number"] { background: #333; color: white; border: 1px solid #444; width: 50px; text-align: center;}
  textarea { 
    background: #252525; 
    color: white; 
    border: 1px solid #444; 
    width: 100%; 
    max-width: 800px; 
    min-height: 100px; 
    margin-top: 10px; 
    font-family: monospace;
  }
  #bubble { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: #0288d1; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; z-index: 9999; user-select: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
  #scrollSlider { width: 90%; margin-top: 20px; accent-color: #0288d1; }
  .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.95); padding: 12px 24px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; border: 1px solid #555; z-index: 10000; font-weight: bold;}
  .toast.show { opacity: 1; }
  .tab-container { 
    display: flex; 
    gap: 10px; 
    margin-bottom: 15px; 
    width: 90%; 
    max-width: 800px; 
  }
  .tab-button { 
    flex: 1; 
    padding: 12px; 
    background: #252525; 
    border: 1px solid #444; 
    color: #bbb; 
    cursor: pointer; 
    text-align: center; 
    border-radius: 8px; 
    transition: all 0.3s;
  }
  .tab-button.active { 
    background: #0288d1; 
    color: white; 
    border-color: #0288d1;
  }
  .tab-content { 
    display: none; 
    width: 90%; 
    max-width: 800px; 
  }
  .tab-content.active { 
    display: block; 
  }
  #pasteArea { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
  #themeVocabulary { 
    background: #1e1e1e; 
    padding: 15px; 
    border-radius: 8px; 
    border: 1px solid #333; 
    margin-top: 10px;
    font-size: 14px;
    line-height: 1.5;
    max-height: 150px;
    overflow-y: auto;
  }
</style>
</head>
<body>
  <div id="clock">00:00</div>
  <div id="date">--/--/----</div>
  <h2 id="appTitle">ğŸ“˜ Há»c tá»« vá»±ng TXT</h2>
  
  <!-- Tab chuyá»ƒn Ä‘á»•i -->
  <div class="tab-container">
    <button class="tab-button active" onclick="switchTab('fileTab')">ğŸ“ Tá»« File</button>
    <button class="tab-button" onclick="switchTab('pasteTab')">ğŸ“ Nháº­p Trá»±c Tiáº¿p</button>
  </div>
  
  <!-- Tab chá»n file -->
  <div id="fileTab" class="tab-content active">
    <div id="displayArea">
      <div style="opacity: 0.7">ğŸ“‚ Chá»n file .txt Ä‘á»ƒ báº¯t Ä‘áº§u</div>
    </div>
    
    <div id="wordInfo" style="display:none; color:#888; margin-bottom: 5px;">0/0</div>
    <input type="range" min="0" max="100" value="0" id="scrollSlider" disabled>

    <div id="controls">
      <input type="file" id="fileInput" accept=".txt">
      <button id="startBtn">â–¶ï¸ Báº¯t Ä‘áº§u</button>
      <button onclick="clearProgress()">ğŸ—‘ï¸ Reset</button>
      <button id="pushNotificationBtn">ğŸ”” Báº­t thÃ´ng bÃ¡o</button>
      <div class="setting-group">â±ï¸ <input type="number" id="timePerGroup" value="5">s</div>
      <div class="setting-group">ğŸ“š <input type="number" id="wordCount" value="5">tá»«</div>
      <div class="setting-group">ğŸ”¤ <input type="range" min="1" max="5" value="1.5" step="0.1" id="fontSize"></div>
    </div>
  </div>
  
  <!-- Tab nháº­p trá»±c tiáº¿p -->
  <div id="pasteTab" class="tab-content">
    <div id="pasteArea">
      <textarea id="vocabInput" placeholder="DÃ¡n tá»« vá»±ng cá»§a báº¡n vÃ o Ä‘Ã¢y (má»—i tá»« má»™t dÃ²ng hoáº·c cÃ¡ch nhau báº±ng dáº¥u pháº©y)..."></textarea>
      <button onclick="loadFromTextarea()" style="background: #0288d1; font-weight: bold;">ğŸ“¥ Táº£i tá»« vá»±ng tá»« Ã´ nháº­p</button>
      
      <div style="margin-top: 20px;">
        <h3 style="color: #64b5f6; margin-bottom: 10px;">ğŸ“Œ Tá»« vá»±ng máº«u - Chá»§ Ä‘á» Sá»­a chá»¯a (Tiáº¿ng HÃ n)</h3>
        <div id="themeVocabulary">
ìˆ˜ë¦¬í•˜ë‹¤ (suri-hada) - Sá»­a chá»¯a<br>
ê³ ì¹˜ë‹¤ (gochi-da) - Sá»­a, chá»¯a<br>
êµì²´í•˜ë‹¤ (gyoche-hada) - Thay tháº¿<br>
ì ê²€í•˜ë‹¤ (jeomgeom-hada) - Kiá»ƒm tra<br>
ì¡°ë¦½í•˜ë‹¤ (jorip-hada) - Láº¯p rÃ¡p<br>
ë¶„í•´í•˜ë‹¤ (bunhae-hada) - ThÃ¡o rá»i<br>
ì²­ì†Œí•˜ë‹¤ (cheongso-hada) - Vá»‡ sinh<br>
ì¡°ì •í•˜ë‹¤ (jojeong-hada) - Äiá»u chá»‰nh<br>
ì„¤ì¹˜í•˜ë‹¤ (seolchi-hada) - CÃ i Ä‘áº·t, láº¯p Ä‘áº·t<br>
ë³´ìˆ˜í•˜ë‹¤ (bosu-hada) - Báº£o trÃ¬<br>
ìˆ˜ì„ í•˜ë‹¤ (suseon-hada) - Sá»­a chá»¯a (quáº§n Ã¡o)<br>
ë„ìƒ‰í•˜ë‹¤ (dosaek-hada) - SÆ¡n<br>
ìš©ì ‘í•˜ë‹¤ (yongjeop-hada) - HÃ n<br>
ì—°ë§ˆí•˜ë‹¤ (yeonma-hada) - MÃ i<br>
ë“œë¦´ (deuril) - MÃ¡y khoan<br>
ë§ì¹˜ (mangchi) - BÃºa<br>
ë Œì¹˜ (renchi) - Cá» lÃª<br>
ìŠ¤íŒ¨ë„ˆ (seupaeneo) - Má» láº¿t<br>
ë“œë¼ì´ë²„ (deuraibeo) - Tua vÃ­t<br>
í†± (top) - CÆ°a
        </div>
        <button onclick="loadSampleVocabulary()" style="background: #6a1b9a; margin-top: 10px;">ğŸ“‹ Sá»­ dá»¥ng tá»« vá»±ng máº«u</button>
      </div>
    </div>
    
    <div id="pasteWordInfo" style="display:none; color:#888; margin-bottom: 5px; margin-top: 10px;">0/0</div>
    <input type="range" min="0" max="100" value="0" id="pasteScrollSlider" disabled style="width: 90%; margin-top: 10px; accent-color: #0288d1;">
    
    <div id="pasteControls" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; width: 100%; max-width: 800px; margin-top: 15px;">
      <button id="pasteStartBtn" style="background: #2e7d32; font-weight: bold;">â–¶ï¸ Báº¯t Ä‘áº§u há»c tá»« nháº­p</button>
      <button onclick="clearPasteProgress()">ğŸ—‘ï¸ Reset tá»« nháº­p</button>
      <div class="setting-group">â±ï¸ <input type="number" id="pasteTimePerGroup" value="5">s</div>
      <div class="setting-group">ğŸ“š <input type="number" id="pasteWordCount" value="5">tá»«</div>
    </div>
  </div>
  
  <div id="bubble">â¸ï¸</div>
  <div id="toast" class="toast">ThÃ´ng bÃ¡o</div>

<script>
// ========== KHAI BÃO BIáº¾N ==========
let words = [], currentIndex = 0, intervalTimer, isRunning = false, pushEnabled = false;
let pasteWords = [], pasteCurrentIndex = 0, pasteIntervalTimer, isPasteRunning = false;
let currentTab = 'fileTab';

const els = { 
    clock: document.getElementById('clock'), date: document.getElementById('date'), 
    display: document.getElementById('displayArea'), slider: document.getElementById('scrollSlider'), 
    fileInput: document.getElementById('fileInput'), controls: document.getElementById('controls'), 
    bubble: document.getElementById('bubble'), wordInfo: document.getElementById('wordInfo'), 
    notifBtn: document.getElementById('pushNotificationBtn'), toast: document.getElementById('toast'),
    vocabInput: document.getElementById('vocabInput'),
    pasteWordInfo: document.getElementById('pasteWordInfo'),
    pasteSlider: document.getElementById('pasteScrollSlider'),
    pasteControls: document.getElementById('pasteControls')
};

// ========== LOGIC Äá»’NG Há»’ ==========
setInterval(() => { 
    const now = new Date(); 
    els.clock.textContent = now.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}); 
    els.date.textContent = now.toLocaleDateString('vi-VN',{weekday:'short',day:'2-digit',month:'long'}); 
}, 1000);

// ========== CHUYá»‚N TAB ==========
function switchTab(tabName) {
    currentTab = tabName;
    
    // Cáº­p nháº­t tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Cáº­p nháº­t tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName).classList.add('active');
    
    // Hiá»ƒn thá»‹ dá»¯ liá»‡u tÆ°Æ¡ng á»©ng
    if (tabName === 'fileTab' && words.length > 0) {
        els.display.innerHTML = `âœ… ÄÃ£ táº£i <b>${words.length}</b> tá»«. Vui lÃ²ng nháº¥n Báº®T Äáº¦U.`;
        els.slider.disabled = false;
        els.slider.max = words.length - 1;
    } else if (tabName === 'pasteTab' && pasteWords.length > 0) {
        els.vocabInput.value = pasteWords.join('\n');
    }
}

// ========== Xá»¬ LÃ FILE TXT ==========
els.fileInput.addEventListener('change', e => {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => { 
    words = ev.target.result.split(/[,;\n]+/).map(w=>w.trim()).filter(w=>w); 
    if(words.length){ 
        els.display.innerHTML=`âœ… ÄÃ£ táº£i <b>${words.length}</b> tá»«. Vui lÃ²ng nháº¥n Báº®T Äáº¦U.`; 
        els.slider.disabled=false; 
        els.slider.max=words.length-1; 
        saveState(); 
        showToast(`ÄÃ£ táº£i ${words.length} tá»«`); 
    }
  };
  reader.readAsText(file);
});

// ========== Xá»¬ LÃ NHáº¬P TRá»°C TIáº¾P ==========
function loadFromTextarea() {
    const text = els.vocabInput.value.trim();
    if (!text) {
        showToast('âš ï¸ Vui lÃ²ng nháº­p tá»« vá»±ng!');
        return;
    }
    
    pasteWords = text.split(/[,;\n]+/).map(w=>w.trim()).filter(w=>w);
    if (pasteWords.length) {
        showToast(`âœ… ÄÃ£ táº£i ${pasteWords.length} tá»« tá»« Ã´ nháº­p`);
        els.pasteSlider.disabled = false;
        els.pasteSlider.max = pasteWords.length - 1;
        els.pasteWordInfo.style.display = 'block';
        els.pasteWordInfo.innerText = `0/${pasteWords.length}`;
        savePasteState();
    }
}

function loadSampleVocabulary() {
    const sampleText = `ìˆ˜ë¦¬í•˜ë‹¤ (suri-hada) - Sá»­a chá»¯a
ê³ ì¹˜ë‹¤ (gochi-da) - Sá»­a, chá»¯a
êµì²´í•˜ë‹¤ (gyoche-hada) - Thay tháº¿
ì ê²€í•˜ë‹¤ (jeomgeom-hada) - Kiá»ƒm tra
ì¡°ë¦½í•˜ë‹¤ (jorip-hada) - Láº¯p rÃ¡p
ë¶„í•´í•˜ë‹¤ (bunhae-hada) - ThÃ¡o rá»i
ì²­ì†Œí•˜ë‹¤ (cheongso-hada) - Vá»‡ sinh
ì¡°ì •í•˜ë‹¤ (jojeong-hada) - Äiá»u chá»‰nh
ì„¤ì¹˜í•˜ë‹¤ (seolchi-hada) - CÃ i Ä‘áº·t, láº¯p Ä‘áº·t
ë³´ìˆ˜í•˜ë‹¤ (bosu-hada) - Báº£o trÃ¬
ìˆ˜ì„ í•˜ë‹¤ (suseon-hada) - Sá»­a chá»¯a (quáº§n Ã¡o)
ë„ìƒ‰í•˜ë‹¤ (dosaek-hada) - SÆ¡n
ìš©ì ‘í•˜ë‹¤ (yongjeop-hada) - HÃ n
ì—°ë§ˆí•˜ë‹¤ (yeonma-hada) - MÃ i
ë“œë¦´ (deuril) - MÃ¡y khoĞ°Ğ½
ë§ì¹˜ (mangchi) - BÃºa
ë Œì¹˜ (renchi) - Cá» lÃª
ìŠ¤íŒ¨ë„ˆ (seupaeneo) - Má» láº¿t
ë“œë¼ì´ë²„ (deuraibeo) - Tua vÃ­t
í†± (top) - CÆ°a`;
    
    els.vocabInput.value = sampleText;
    loadFromTextarea();
}

// ========== Báº®T Äáº¦U/Dá»ªNG Há»ŒC (FILE) ==========
document.getElementById('startBtn').addEventListener('click', startLearning);
els.bubble.addEventListener('click', stopLearning);

function startLearning() {
  if(currentTab !== 'fileTab') return;
  if(!words.length) return showToast('âš ï¸ ChÆ°a cÃ³ file!');
  
  isRunning = true; 
  els.controls.style.display='none'; 
  document.getElementById('appTitle').style.display='none'; 
  els.fileInput.style.display='none'; 
  els.bubble.style.display='flex'; 
  els.wordInfo.style.display='block';
  
  const count = parseInt(document.getElementById('wordCount').value)||5;
  const time = (parseInt(document.getElementById('timePerGroup').value)||5)*1000; 
  
  const show = () => {
    if(currentIndex >= words.length) { stopLearning(); return showToast('ğŸ‰ HoÃ n thÃ nh!'); }
    
    const chunk = words.slice(currentIndex, currentIndex+count);
    
    els.display.innerText = chunk.map((w,i)=>`${currentIndex+i+1}. ${w}`).join('\n\n'); 
    els.slider.value = currentIndex; 
    els.wordInfo.innerText = `${currentIndex+1} - ${Math.min(currentIndex+count, words.length)} / ${words.length}`;
    
    if(pushEnabled) {
        const wordList = chunk.map(w => "â€¢ " + w).join('\n'); 
        const title = `ğŸ“– Há»c (File): ${currentIndex+1} - ${currentIndex + chunk.length} / ${words.length}`;
        sendNotification(title, wordList);
    }
    
    currentIndex += count; 
    saveState();
  };
  
  show(); 
  intervalTimer = setInterval(show, time);
  
  if(pushEnabled) sendNotification('ğŸš€ Báº¯t Ä‘áº§u há»c tá»« file', 'Tá»« vá»±ng sáº½ hiá»‡n trÃªn thÃ´ng bÃ¡o!');
}

function stopLearning() {
  if(isRunning) {
    isRunning=false; clearInterval(intervalTimer); 
  }
  if(isPasteRunning) {
    isPasteRunning=false; clearInterval(pasteIntervalTimer);
  }
  
  els.controls.style.display='flex'; 
  document.getElementById('appTitle').style.display='block'; 
  els.fileInput.style.display='block'; 
  els.bubble.style.display='none'; 
  
  if(currentTab === 'fileTab') {
    els.display.innerHTML=`â¸ï¸ <b>Táº¡m dá»«ng</b><br>Tiáº¿p tá»¥c tá»« vá»‹ trÃ­: ${currentIndex}`; 
    saveState();
  } else if(currentTab === 'pasteTab') {
    els.display.innerHTML=`â¸ï¸ <b>Táº¡m dá»«ng</b><br>Tiáº¿p tá»¥c tá»« vá»‹ trÃ­: ${pasteCurrentIndex}`; 
    savePasteState();
  }
}

// ========== Báº®T Äáº¦U/Dá»ªNG Há»ŒC (NHáº¬P TRá»°C TIáº¾P) ==========
document.getElementById('pasteStartBtn').addEventListener('click', startPasteLearning);

function startPasteLearning() {
  if(currentTab !== 'pasteTab') return;
  if(!pasteWords.length) return showToast('âš ï¸ ChÆ°a cÃ³ tá»« vá»±ng! Vui lÃ²ng táº£i tá»« Ã´ nháº­p.');
  
  isPasteRunning = true; 
  els.pasteControls.style.display='none'; 
  document.getElementById('appTitle').style.display='none'; 
  els.bubble.style.display='flex'; 
  els.pasteWordInfo.style.display='block';
  
  const count = parseInt(document.getElementById('pasteWordCount').value)||5;
  const time = (parseInt(document.getElementById('pasteTimePerGroup').value)||5)*1000; 
  
  const show = () => {
    if(pasteCurrentIndex >= pasteWords.length) { 
      isPasteRunning = false;
      clearInterval(pasteIntervalTimer);
      els.pasteControls.style.display='flex'; 
      document.getElementById('appTitle').style.display='block'; 
      els.bubble.style.display='none'; 
      return showToast('ğŸ‰ HoÃ n thÃ nh tá»« nháº­p!'); 
    }
    
    const chunk = pasteWords.slice(pasteCurrentIndex, pasteCurrentIndex+count);
    
    els.display.innerText = chunk.map((w,i)=>`${pasteCurrentIndex+i+1}. ${w}`).join('\n\n'); 
    els.pasteSlider.value = pasteCurrentIndex; 
    els.pasteWordInfo.innerText = `${pasteCurrentIndex+1} - ${Math.min(pasteCurrentIndex+count, pasteWords.length)} / ${pasteWords.length}`;
    
    if(pushEnabled) {
        const wordList = chunk.map(w => "â€¢ " + w).join('\n'); 
        const title = `ğŸ“– Há»c (Nháº­p): ${pasteCurrentIndex+1} - ${pasteCurrentIndex + chunk.length} / ${pasteWords.length}`;
        sendNotification(title, wordList);
    }
    
    pasteCurrentIndex += count; 
    savePasteState();
  };
  
  show(); 
  pasteIntervalTimer = setInterval(show, time);
  
  if(pushEnabled) sendNotification('ğŸš€ Báº¯t Ä‘áº§u há»c tá»« nháº­p', 'Tá»« vá»±ng sáº½ hiá»‡n trÃªn thÃ´ng bÃ¡o!');
}

// ========== CÃ€I Äáº¶T VÃ€ TRáº NG THÃI ==========
els.slider.addEventListener('input', e => { 
    currentIndex=parseInt(e.target.value); 
    els.wordInfo.innerText=`${currentIndex}/${words.length}`; 
    if(!isRunning) els.display.innerText=`${currentIndex}: ${words[currentIndex]||''}`; 
    saveState();
});

els.pasteSlider.addEventListener('input', e => { 
    pasteCurrentIndex=parseInt(e.target.value); 
    els.pasteWordInfo.innerText=`${pasteCurrentIndex}/${pasteWords.length}`; 
    if(!isPasteRunning) els.display.innerText=`${pasteCurrentIndex}: ${pasteWords[pasteCurrentIndex]||''}`; 
    savePasteState();
});

document.getElementById('fontSize').addEventListener('input', e => {
    els.display.style.fontSize=e.target.value+'em'; 
    saveState();
});

document.getElementById('wordCount').addEventListener('input', saveState);
document.getElementById('timePerGroup').addEventListener('input', saveState);
document.getElementById('pasteWordCount').addEventListener('input', savePasteState);
document.getElementById('pasteTimePerGroup').addEventListener('input', savePasteState);

// ========== LOGIC PUSH NOTIFICATION ==========
els.notifBtn.addEventListener('click', async () => {
  if (!('serviceWorker' in navigator) || !('Notification' in window)) return alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ thÃ´ng bÃ¡o.");
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') return showToast('âŒ Cáº§n cáº¥p quyá»n thÃ´ng bÃ¡o');

  try {
    await navigator.serviceWorker.register('sw.js');
    pushEnabled = true;
    els.notifBtn.innerHTML = "ğŸ”” ÄÃ£ báº­t (Äang cháº¡y)"; 
    els.notifBtn.classList.add('active');
    showToast("âœ… ÄÃ£ báº­t thÃ´ng bÃ¡o!");
    sendNotification("ğŸ”” Test ThÃ nh cÃ´ng", "Tá»« vá»±ng sáº½ hiá»‡n rÃµ rÃ ng á»Ÿ Ä‘Ã¢y!");
  } catch (err) {
    alert("Lá»—i Ä‘Äƒng kÃ½ Service Worker: " + err.message + "\n\nHÃ£y cháº¯c cháº¯n file sw.js Ä‘Ã£ Ä‘Æ°á»£c táº£i lÃªn cÃ¹ng thÆ° má»¥c.");
  }
});

function sendNotification(title, body) {
  if (!pushEnabled) return;
  const icon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ“˜%3C/text%3E%3C/svg%3E";
  
  navigator.serviceWorker.ready.then(reg => {
      reg.showNotification(title, { 
          body: body, 
          icon: icon, 
          tag: 'vocab-app',
          renotify: true,
          vibrate: [100, 50, 100],
          silent: false 
      });
  });
}

// ========== TIá»†N ÃCH CHUNG ==========
function showToast(msg) { 
    els.toast.textContent=msg; 
    els.toast.classList.add('show'); 
    setTimeout(()=>els.toast.classList.remove('show'),3000); 
}

function saveState() { 
    localStorage.setItem('vocabState', JSON.stringify({
        words, currentIndex, 
        settings:{
            fontSize:document.getElementById('fontSize').value, 
            count:document.getElementById('wordCount').value, 
            time:document.getElementById('timePerGroup').value
        }
    })); 
}

function savePasteState() {
    localStorage.setItem('vocabPasteState', JSON.stringify({
        pasteWords, pasteCurrentIndex,
        settings: {
            count: document.getElementById('pasteWordCount').value,
            time: document.getElementById('pasteTimePerGroup').value
        },
        inputText: els.vocabInput.value
    }));
}

function loadState() { 
    const raw = localStorage.getItem('vocabState');
    if(raw) {
        const d = JSON.parse(raw); 
        if(d?.words?.length) { 
            words=d.words; currentIndex=d.currentIndex||0; 
            els.slider.max=words.length-1; 
            els.slider.disabled=false;
            els.display.innerHTML=`ğŸ“‚ ÄÃ£ khÃ´i phá»¥c phiÃªn trÆ°á»›c.<br>Vá»‹ trÃ­: <b>${currentIndex}</b> / ${words.length}`; 
        } 
        if (d?.settings) {
            document.getElementById('fontSize').value = d.settings.fontSize || 1.5;
            els.display.style.fontSize = (d.settings.fontSize || 1.5) + 'em';
            document.getElementById('wordCount').value = d.settings.count || 5;
            document.getElementById('timePerGroup').value = d.settings.time || 5;
        }
    }
}

function loadPasteState() {
    const raw = localStorage.getItem('vocabPasteState');
    if(raw) {
        const d = JSON.parse(raw);
        if(d?.pasteWords?.length) {
            pasteWords = d.pasteWords;
            pasteCurrentIndex = d.pasteCurrentIndex || 0;
            els.pasteSlider.max = pasteWords.length - 1;
            els.pasteSlider.disabled = false;
            els.vocabInput.value = d.inputText || pasteWords.join('\n');
            els.pasteWordInfo.style.display = 'block';
            els.pasteWordInfo.innerText = `${pasteCurrentIndex}/${pasteWords.length}`;
        }
        if (d?.settings) {
            document.getElementById('pasteWordCount').value = d.settings.count || 5;
            document.getElementById('pasteTimePerGroup').value = d.settings.time || 5;
        }
    }
}

function clearProgress() { 
    if(confirm("XÃ³a toÃ n bá»™ dá»¯ liá»‡u há»c vÃ  cÃ i Ä‘áº·t tá»« file?")) { 
        localStorage.removeItem('vocabState'); 
        location.reload(); 
    } 
}

function clearPasteProgress() {
    if(confirm("XÃ³a toÃ n bá»™ dá»¯ liá»‡u há»c tá»« Ã´ nháº­p?")) {
        localStorage.removeItem('vocabPasteState');
        pasteWords = [];
        pasteCurrentIndex = 0;
        els.vocabInput.value = '';
        els.pasteSlider.disabled = true;
        els.pasteWordInfo.style.display = 'none';
        showToast('ÄÃ£ xÃ³a dá»¯ liá»‡u nháº­p');
    }
}

// Drag bubble (mousedown for desktop, touchstart for mobile)
let isDragging = false;
const dragLogic = (e) => {
    isDragging = false; 
    const isTouch = e.type.startsWith('touch');
    const client = isTouch ? e.touches[0] : e;
    
    const off = {
        x: client.clientX - els.bubble.getBoundingClientRect().left, 
        y: client.clientY - els.bubble.getBoundingClientRect().top
    };
    
    const move = (ev) => {
        isDragging = true; 
        const currentClient = isTouch ? ev.touches[0] : ev;
        els.bubble.style.left = (currentClient.clientX - off.x) + 'px'; 
        els.bubble.style.top = (currentClient.clientY - off.y) + 'px';
        els.bubble.style.right = 'auto'; 
        els.bubble.style.bottom = 'auto';
        if (isTouch) ev.preventDefault();
    };

    const end = () => {
        const eventType = isTouch ? 'touchmove' : 'mousemove';
        document.removeEventListener(eventType, move);
        
        if (isDragging) {
            els.bubble.style.pointerEvents = "none";
            setTimeout(() => {
                els.bubble.style.pointerEvents = "auto";
            }, 50); 
        }
    };
    
    const eventType = isTouch ? 'touchmove' : 'mousemove';
    document.addEventListener(eventType, move, { passive: !isTouch });
    document.addEventListener(isTouch ? 'touchend' : 'mouseup', end, { once: true });
};

els.bubble.addEventListener('mousedown', dragLogic);
els.bubble.addEventListener('touchstart', dragLogic);

// ========== KHá»I Táº O ==========
window.addEventListener('load', () => {
    loadState();
    loadPasteState();
    setTimeout(() => window.scrollTo(0, 1), 100);
});
</script>
</body>
</html>
