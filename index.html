<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Há»c tá»« vá»±ng TXT</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“˜</text></svg>">
<style>
  body { background: #121212; color: #e0e0e0; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; margin: 0; }
  h2 { color: #64b5f6; }
  #clock { font-size: 3.5em; font-weight: bold; margin-top: 10px; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
  #date { font-size: 1.1em; color: #aaa; margin-bottom: 20px; }
  #displayArea { width: 90%; max-width: 800px; text-align: center; font-size: 1.5em; line-height: 1.6; margin: 20px 0; padding: 20px; background: #1e1e1e; border-radius: 15px; border: 1px solid #333; min-height: 100px; white-space: pre-wrap; }
  #controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; width: 100%; max-width: 800px; }
  button, input, .setting-group { padding: 10px; border-radius: 8px; border: none; font-size: 14px; }
  button { background: #424242; color: white; cursor: pointer; border: 1px solid #555; }
  #startBtn { background: #2e7d32; }
  #pushNotificationBtn { background: linear-gradient(135deg, #1565c0, #6a1b9a); color: white; font-weight: bold; }
  #pushNotificationBtn.active { background: #2e7d32; }
  .setting-group { background: #252525; display: flex; align-items: center; gap: 5px; color: #bbb; }
  input[type="number"] { background: #333; color: white; border: 1px solid #444; width: 50px; }
  #bubble { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #0288d1; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 9999; user-select: none; }
  #scrollSlider { width: 90%; margin-top: 20px; accent-color: #0288d1; }
  .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(50,50,50,0.9); padding: 12px 24px; border-radius: 30px; opacity: 0; transition: 0.3s; pointer-events: none; border: 1px solid #555; z-index: 10000;}
  .toast.show { opacity: 1; }
</style>
</head>
<body>
  <div id="clock">00:00</div>
  <div id="date">--/--/----</div>
  <h2 id="appTitle">ğŸ“˜ Há»c tá»« vá»±ng TXT</h2>
  <div id="displayArea">ğŸ“‚ Chá»n file .txt Ä‘á»ƒ báº¯t Ä‘áº§u</div>
  <div id="wordInfo" style="display:none; color:#888">0/0</div>
  <input type="range" min="0" max="100" value="0" id="scrollSlider" disabled>

  <div id="controls">
    <input type="file" id="fileInput" accept=".txt">
    <button id="startBtn">â–¶ï¸ Báº¯t Ä‘áº§u</button>
    <button onclick="clearProgress()">ğŸ—‘ï¸ Reset</button>
    <button id="pushNotificationBtn">ğŸ”” Báº­t thÃ´ng bÃ¡o</button>
    <div class="setting-group">â±ï¸ <input type="number" id="timePerGroup" value="3">s</div>
    <div class="setting-group">ğŸ“š <input type="number" id="wordCount" value="5">tá»«</div>
    <div class="setting-group">ğŸ”¤ <input type="range" min="1" max="5" value="1.5" step="0.1" id="fontSize"></div>
  </div>
  <div id="bubble">â¸ï¸</div>
  <div id="toast" class="toast">ThÃ´ng bÃ¡o</div>

<script>
let words = [], currentIndex = 0, intervalTimer, isRunning = false, pushEnabled = false;
const els = { clock: document.getElementById('clock'), date: document.getElementById('date'), display: document.getElementById('displayArea'), slider: document.getElementById('scrollSlider'), fileInput: document.getElementById('fileInput'), controls: document.getElementById('controls'), bubble: document.getElementById('bubble'), wordInfo: document.getElementById('wordInfo'), notifBtn: document.getElementById('pushNotificationBtn'), toast: document.getElementById('toast') };

setInterval(() => { const now = new Date(); els.clock.textContent = now.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}); els.date.textContent = now.toLocaleDateString('vi-VN',{weekday:'short',day:'2-digit',month:'long'}); }, 1000);

els.fileInput.addEventListener('change', e => {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => { words = ev.target.result.split(/[,;\n]+/).map(w=>w.trim()).filter(w=>w); if(words.length){ els.display.innerHTML=`âœ… ÄÃ£ táº£i <b>${words.length}</b> tá»«.`; els.slider.disabled=false; els.slider.max=words.length-1; saveState(); showToast(`ÄÃ£ táº£i ${words.length} tá»«`); }};
  reader.readAsText(file);
});

document.getElementById('startBtn').addEventListener('click', startLearning);
els.bubble.addEventListener('click', stopLearning);

function startLearning() {
  if(!words.length) return showToast('âš ï¸ ChÆ°a cÃ³ file!');
  isRunning = true; els.controls.style.display='none'; document.getElementById('appTitle').style.display='none'; els.fileInput.style.display='none'; els.bubble.style.display='flex'; els.wordInfo.style.display='block';
  const count = parseInt(document.getElementById('wordCount').value)||5, time = (parseInt(document.getElementById('timePerGroup').value)||3)*1000;
  
  const show = () => {
    if(currentIndex >= words.length) { stopLearning(); return showToast('ğŸ‰ HoÃ n thÃ nh!'); }
    const chunk = words.slice(currentIndex, currentIndex+count);
    els.display.innerText = chunk.map((w,i)=>`${currentIndex+i+1}. ${w}`).join('\n\n'); els.slider.value = currentIndex; els.wordInfo.innerText = `${currentIndex+1}/${words.length}`;
    if(pushEnabled && currentIndex%(count*2)===0) sendNotification(`Há»c: ${currentIndex+1}/${words.length}`, chunk.slice(0,2).join(', ')+'...');
    currentIndex += count; saveState();
  };
  show(); intervalTimer = setInterval(show, time);
  if(pushEnabled) sendNotification('ğŸš€ Báº¯t Ä‘áº§u', 'Giá»¯ mÃ n hÃ¬nh sÃ¡ng Ä‘á»ƒ há»c tá»‘t nháº¥t!');
}

function stopLearning() {
  isRunning=false; clearInterval(intervalTimer); els.controls.style.display='flex'; document.getElementById('appTitle').style.display='block'; els.fileInput.style.display='block'; els.bubble.style.display='none'; els.display.innerHTML=`â¸ï¸ <b>Táº¡m dá»«ng</b><br>Vá»‹ trÃ­: ${currentIndex}`; saveState();
}

els.slider.addEventListener('input', e => { currentIndex=parseInt(e.target.value); els.wordInfo.innerText=`${currentIndex}/${words.length}`; if(!isRunning) els.display.innerText=`${currentIndex}: ${words[currentIndex]||''}`; });
document.getElementById('fontSize').addEventListener('input', e => els.display.style.fontSize=e.target.value+'em');

// === PHáº¦N QUAN TRá»ŒNG: Káº¾T Ná»I SW.JS ===
els.notifBtn.addEventListener('click', async () => {
  if (!('serviceWorker' in navigator)) return alert("TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£.");
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') return showToast('âŒ Cáº§n cáº¥p quyá»n thÃ´ng bÃ¡o');

  try {
    // ÄÄƒng kÃ½ file sw.js tháº­t
    await navigator.serviceWorker.register('sw.js'); // <--- ÄÃ‚Y LÃ€ CHá»– ÄÃƒ Sá»¬A
    pushEnabled = true;
    els.notifBtn.innerHTML = "ğŸ”” ÄÃ£ báº­t"; els.notifBtn.classList.add('active');
    showToast("âœ… ÄÃ£ báº­t thÃ´ng bÃ¡o!");
    sendNotification("ğŸ”” Test", "ThÃ´ng bÃ¡o hoáº¡t Ä‘á»™ng!");
  } catch (err) {
    alert("Lá»—i: " + err.message);
  }
});

function sendNotification(title, body) {
  if (!pushEnabled) return;
  const icon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ“˜%3C/text%3E%3C/svg%3E";
  navigator.serviceWorker.ready.then(reg => reg.showNotification(title, { body, icon, tag: 'vocab-app', silent: false }));
}

function showToast(msg) { els.toast.textContent=msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'),3000); }
function saveState() { localStorage.setItem('vocabState', JSON.stringify({words, currentIndex, settings:{fontSize:document.getElementById('fontSize').value, count:document.getElementById('wordCount').value, time:document.getElementById('timePerGroup').value}})); }
function loadState() { const d = JSON.parse(localStorage.getItem('vocabState')); if(d?.words?.length) { words=d.words; currentIndex=d.currentIndex||0; els.slider.max=words.length-1; els.display.innerText=`ğŸ“‚ KhÃ´i phá»¥c: ${currentIndex}/${words.length}`; } }
function clearProgress() { if(confirm("XÃ³a?")) { localStorage.removeItem('vocabState'); location.reload(); } }
// Drag bubble logic
let isDragging = false;
els.bubble.addEventListener('mousedown', e => { isDragging=false; const off={x:e.clientX-els.bubble.getBoundingClientRect().left, y:e.clientY-els.bubble.getBoundingClientRect().top}; const move=ev=>{isDragging=true; els.bubble.style.left=(ev.clientX-off.x)+'px'; els.bubble.style.top=(ev.clientY-off.y)+'px';els.bubble.style.right='auto';els.bubble.style.bottom='auto';}; document.addEventListener('mousemove',move); document.addEventListener('mouseup',()=>{document.removeEventListener('mousemove',move); if(isDragging){const old=els.bubble.onclick; els.bubble.onclick=null; setTimeout(()=>els.bubble.onclick=old,100);}},{once:true}); });
// Touch support for drag
els.bubble.addEventListener('touchstart', e => { isDragging=false; const touch=e.touches[0]; const off={x:touch.clientX-els.bubble.getBoundingClientRect().left, y:touch.clientY-els.bubble.getBoundingClientRect().top}; const move=ev=>{isDragging=true; els.bubble.style.left=(ev.touches[0].clientX-off.x)+'px'; els.bubble.style.top=(ev.touches[0].clientY-off.y)+'px';els.bubble.style.right='auto';els.bubble.style.bottom='auto';ev.preventDefault();}; document.addEventListener('touchmove',move,{passive:false}); document.addEventListener('touchend',()=>{document.removeEventListener('touchmove',move); if(isDragging){const old=els.bubble.onclick; els.bubble.onclick=null; setTimeout(()=>els.bubble.onclick=old,100);}},{once:true}); });

window.addEventListener('load', loadState);
</script>
</body>
</html>
