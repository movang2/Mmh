<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H·ªçc t·ª´ v·ª±ng All-in-One</title>
<style>
  /* --- CSS GIAO DI·ªÜN --- */
  body {
    background: #121212;
    color: #e0e0e0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    margin: 0;
    min-height: 100vh;
    transition: background 0.3s;
  }
  h2 { color: #64b5f6; margin-bottom: 20px; }
  
  /* ƒê·ªìng h·ªì */
  #clock { font-size: 3.5em; font-weight: bold; margin-top: 10px; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
  #date { font-size: 1.1em; color: #aaa; margin-bottom: 20px; }
  
  /* Khu v·ª±c hi·ªÉn th·ªã t·ª´ */
  #displayArea {
    width: 90%; max-width: 800px;
    text-align: center;
    font-size: 1.5em;
    line-height: 1.6;
    margin: 20px 0;
    padding: 20px;
    white-space: pre-wrap;
    background: #1e1e1e;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    border: 1px solid #333;
    min-height: 100px;
    display: flex; align-items: center; justify-content: center; flex-direction: column;
  }

  /* Controls */
  #controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; width: 100%; max-width: 800px; }
  
  button, input[type="file"], .setting-group {
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    font-size: 14px;
    cursor: pointer;
  }
  
  button { background: #424242; color: white; transition: 0.2s; border: 1px solid #555; }
  button:hover { background: #616161; transform: translateY(-2px); }
  button:active { transform: translateY(0); }
  
  #startBtn { background: #2e7d32; } /* Green */
  #startBtn:hover { background: #388e3c; }
  
  /* N√∫t th√¥ng b√°o ƒë·∫∑c bi·ªát */
  #pushNotificationBtn {
    background: linear-gradient(135deg, #1565c0, #6a1b9a);
    color: white;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(21, 101, 192, 0.4);
  }
  #pushNotificationBtn.active {
    background: linear-gradient(135deg, #2e7d32, #66bb6a);
    box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4);
  }
  #pushNotificationBtn.disabled { background: #444; color: #888; cursor: not-allowed; box-shadow: none; }

  /* C√†i ƒë·∫∑t input */
  .setting-group { background: #252525; display: flex; align-items: center; gap: 5px; color: #bbb; padding: 5px 10px; }
  input[type="number"], input[type="range"] { background: #333; color: white; border: 1px solid #444; padding: 5px; border-radius: 4px; }
  input[type="range"] { cursor: pointer; }

  /* Bubble Controls */
  #bubble {
    position: fixed; bottom: 30px; right: 30px;
    width: 60px; height: 60px;
    background: #0288d1;
    color: white;
    border-radius: 50%;
    display: none;
    align-items: center; justify-content: center;
    font-size: 24px;
    cursor: pointer;
    z-index: 9999;
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    user-select: none;
    transition: transform 0.1s;
  }
  #bubble:active { transform: scale(0.9); }

  /* Slider ƒëi·ªÅu h∆∞·ªõng */
  #scrollSlider { width: 90%; max-width: 800px; margin-top: 20px; accent-color: #0288d1; }
  #wordInfo { color: #888; margin-top: 5px; font-size: 0.9em; }

  /* Toast Message */
  .toast {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(50, 50, 50, 0.9); color: #fff;
    padding: 12px 24px; border-radius: 30px;
    font-size: 14px; z-index: 10000;
    opacity: 0; transition: opacity 0.3s; pointer-events: none;
    border: 1px solid #555;
  }
  .toast.show { opacity: 1; }
</style>
</head>
<body>

  <div id="clock">00:00</div>
  <div id="date">--/--/----</div>
  
  <h2 id="appTitle">üìò H·ªçc t·ª´ v·ª±ng TXT</h2>
  
  <div id="displayArea">
    <div style="opacity: 0.7;">
      üìÇ Ch·ªçn file .txt ƒë·ªÉ b·∫Øt ƒë·∫ßu<br>
      <small>(ƒê·ªãnh d·∫°ng: t·ª´1, t·ª´2, t·ª´3...)</small>
    </div>
  </div>
  
  <div id="wordInfo" style="display:none">0/0</div>
  <input type="range" min="0" max="100" value="0" id="scrollSlider" disabled>

  <div id="controls">
    <input type="file" id="fileInput" accept=".txt">
    <button id="startBtn">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu ch·∫°y</button>
    <button onclick="clearProgress()">üóëÔ∏è Reset</button>
    <button id="pushNotificationBtn">üîî B·∫≠t th√¥ng b√°o</button>
    
    <div class="setting-group">
      <span>‚è±Ô∏è Gi√¢y/t·ª´:</span>
      <input type="number" id="timePerGroup" min="1" value="3" style="width:50px">
    </div>
    <div class="setting-group">
      <span>üìö S·ªë t·ª´/nh√≥m:</span>
      <input type="number" id="wordCount" min="1" value="5" style="width:50px">
    </div>
    <div class="setting-group">
      <span>üî§ C·ª° ch·ªØ:</span>
      <input type="range" min="1" max="5" value="1.5" step="0.1" id="fontSize">
    </div>
  </div>

  <div id="bubble">‚è∏Ô∏è</div>
  <div id="toast" class="toast">Th√¥ng b√°o</div>

<script>
/* ================= LOGIC ·ª®NG D·ª§NG ================= */

// 1. Khai b√°o bi·∫øn
let words = [];
let currentIndex = 0;
let intervalTimer;
let isRunning = false;
let pushEnabled = false;

// DOM Elements
const els = {
  clock: document.getElementById('clock'),
  date: document.getElementById('date'),
  display: document.getElementById('displayArea'),
  slider: document.getElementById('scrollSlider'),
  fileInput: document.getElementById('fileInput'),
  controls: document.getElementById('controls'),
  bubble: document.getElementById('bubble'),
  wordInfo: document.getElementById('wordInfo'),
  notifBtn: document.getElementById('pushNotificationBtn'),
  toast: document.getElementById('toast')
};

// 2. ƒê·ªìng h·ªì
setInterval(() => {
  const now = new Date();
  els.clock.textContent = now.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'});
  els.date.textContent = now.toLocaleDateString('vi-VN', {weekday:'short', day:'2-digit', month:'long'});
}, 1000);

// 3. X·ª≠ l√Ω file
els.fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = ev => {
    // T√°ch t·ª´ b·∫±ng d·∫•u ph·∫©y, xu·ªëng d√≤ng, ho·∫∑c d·∫•u ch·∫•m ph·∫©y
    const content = ev.target.result;
    words = content.split(/[,;\n]+/).map(w => w.trim()).filter(w => w);
    
    if(words.length > 0) {
      els.display.innerHTML = `‚úÖ ƒê√£ t·∫£i <b>${words.length}</b> t·ª´.<br>S·∫µn s√†ng h·ªçc!`;
      els.slider.disabled = false;
      els.slider.max = words.length - 1;
      saveState();
      showToast(`ƒê√£ t·∫£i ${words.length} t·ª´`);
    }
  };
  reader.readAsText(file);
});

// 4. Logic H·ªçc
document.getElementById('startBtn').addEventListener('click', startLearning);
els.bubble.addEventListener('click', stopLearning);

function startLearning() {
  if(words.length === 0) { showToast('‚ö†Ô∏è Ch∆∞a c√≥ file t·ª´ v·ª±ng!'); return; }
  
  isRunning = true;
  // UI changes
  els.controls.style.display = 'none';
  document.getElementById('appTitle').style.display = 'none';
  els.fileInput.style.display = 'none';
  els.bubble.style.display = 'flex';
  els.wordInfo.style.display = 'block';
  
  // L·∫•y settings
  const count = parseInt(document.getElementById('wordCount').value) || 5;
  const time = (parseInt(document.getElementById('timePerGroup').value) || 3) * 1000;
  
  // H√†m hi·ªÉn th·ªã
  const show = () => {
    if(currentIndex >= words.length) {
      stopLearning();
      showToast('üéâ ƒê√£ h·ªçc h·∫øt danh s√°ch!');
      return;
    }
    
    // L·∫•y nh√≥m t·ª´
    const chunk = words.slice(currentIndex, currentIndex + count);
    const text = chunk.map((w, i) => `${currentIndex + i + 1}. ${w}`).join('\n\n');
    
    els.display.innerText = text;
    els.slider.value = currentIndex;
    els.wordInfo.innerText = `V·ªã tr√≠: ${currentIndex + 1} / ${words.length}`;
    
    // G·ª≠i th√¥ng b√°o n·∫øu b·∫≠t (ch·ªâ g·ª≠i m·ªói 5 l·∫ßn l·∫∑p ƒë·ªÉ tr√°nh spam)
    if(pushEnabled && currentIndex % (count * 2) === 0) {
      sendNotification(`ƒêang h·ªçc: ${currentIndex + 1}/${words.length}`, chunk.slice(0, 2).join(', ') + '...');
    }
    
    currentIndex += count;
    saveState();
  };

  show(); // Ch·∫°y ngay l·∫ßn ƒë·∫ßu
  intervalTimer = setInterval(show, time);
  
  if(pushEnabled) sendNotification('üöÄ B·∫Øt ƒë·∫ßu h·ªçc', 'Gi·ªØ m√†n h√¨nh s√°ng ƒë·ªÉ h·ªçc t·ªët nh·∫•t nh√©!');
}

function stopLearning() {
  isRunning = false;
  clearInterval(intervalTimer);
  
  // UI Reset
  els.controls.style.display = 'flex';
  document.getElementById('appTitle').style.display = 'block';
  els.fileInput.style.display = 'block';
  els.bubble.style.display = 'none';
  
  els.display.innerHTML = `‚è∏Ô∏è <b>T·∫°m d·ª´ng</b><br>Ti·∫øp t·ª•c t·ª´ v·ªã tr√≠: ${currentIndex}`;
  saveState();
}

// 5. Slider & C√†i ƒë·∫∑t
els.slider.addEventListener('input', e => {
  currentIndex = parseInt(e.target.value);
  els.wordInfo.innerText = `V·ªã tr√≠: ${currentIndex} / ${words.length}`;
  if(!isRunning) els.display.innerText = `V·ªã tr√≠ ch·ªçn: ${currentIndex}\n${words[currentIndex] || ''}`;
});

document.getElementById('fontSize').addEventListener('input', e => {
  els.display.style.fontSize = e.target.value + 'em';
  saveState();
});

// ================= SERVICE WORKER "BLOB" MAGIC =================
// ƒê√¢y l√† k·ªπ thu·∫≠t t·∫°o Service Worker t·ª´ chu·ªói string m√† kh√¥ng c·∫ßn file ngo√†i

els.notifBtn.addEventListener('click', toggleNotifications);

async function toggleNotifications() {
  // 1. Ki·ªÉm tra m√¥i tr∆∞·ªùng
  if (window.location.protocol === 'file:') {
    alert("‚ö†Ô∏è L·ªñI: Tr√¨nh duy·ªát ch·∫∑n Service Worker tr√™n file://\n\nüëâ H√£y m·ªü b·∫±ng Localhost (VS Code Live Server) ho·∫∑c upload l√™n GitHub Pages.");
    return;
  }

  if (!('serviceWorker' in navigator) || !('Notification' in window)) {
    alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ th√¥ng b√°o.");
    return;
  }

  // 2. Xin quy·ªÅn
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') {
    showToast('‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn th√¥ng b√°o');
    return;
  }

  // 3. ƒêƒÉng k√Ω "Fake" Service Worker t·ª´ Blob
  try {
    if(!pushEnabled) {
      // Code c·ªßa SW n·∫±m trong bi·∫øn string n√†y
      const swCode = `
        self.addEventListener('install', e => self.skipWaiting());
        self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
        self.addEventListener('notificationclick', e => {
          e.notification.close();
          e.waitUntil(clients.matchAll({type: 'window'}).then(clients => {
            if (clients.length) return clients[0].focus();
            if (clients.openWindow) return clients.openWindow('/');
          }));
        });
      `;
      
      const blob = new Blob([swCode], {type: 'application/javascript'});
      const swUrl = URL.createObjectURL(blob);
      
      const reg = await navigator.serviceWorker.register(swUrl);
      console.log('Blob SW registered:', reg);
      
      pushEnabled = true;
      els.notifBtn.innerHTML = "üîî ƒê√£ b·∫≠t (Click ƒë·ªÉ t·∫Øt)";
      els.notifBtn.classList.add('active');
      showToast("‚úÖ ƒê√£ k√≠ch ho·∫°t th√¥ng b√°o n·ªÅn!");
      
      // Test ngay 1 c√°i
      sendNotification("üîî Test Th√¥ng b√°o", "H·ªá th·ªëng th√¥ng b√°o ƒë√£ s·∫µn s√†ng!");
    } else {
      // T·∫Øt logic (ƒë∆°n gi·∫£n l√† set flag false)
      pushEnabled = false;
      els.notifBtn.innerHTML = "üîî B·∫≠t th√¥ng b√°o";
      els.notifBtn.classList.remove('active');
      showToast("üîï ƒê√£ t·∫Øt th√¥ng b√°o");
    }
  } catch (err) {
    console.error(err);
    alert("L·ªói: " + err.message);
  }
}

function sendNotification(title, body) {
  if (!pushEnabled) return;
  
  // Icon s√°ch v·ªü (SVG Data URI)
  const icon = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüìò%3C/text%3E%3C/svg%3E";

  // ∆Øu ti√™n d√πng SW ƒë·ªÉ hi·ªán th√¥ng b√°o (ho·∫°t ƒë·ªông t·ªët tr√™n Android)
  navigator.serviceWorker.ready.then(reg => {
    reg.showNotification(title, {
      body: body,
      icon: icon,
      badge: icon,
      vibrate: [100, 50, 100],
      tag: 'vocab-app' // Ghi ƒë√® th√¥ng b√°o c≈© ƒë·ªÉ kh√¥ng b·ªã spam
    });
  }).catch(() => {
    // Fallback n·∫øu SW l·ªói
    new Notification(title, { body, icon });
  });
}

// ================= UTILITIES =================

function showToast(msg) {
  els.toast.textContent = msg;
  els.toast.classList.add('show');
  setTimeout(() => els.toast.classList.remove('show'), 3000);
}

// K√©o th·∫£ Bong b√≥ng
let isDragging = false;
els.bubble.addEventListener('mousedown', e => {
  isDragging = false;
  const offset = { x: e.clientX - els.bubble.getBoundingClientRect().left, y: e.clientY - els.bubble.getBoundingClientRect().top };
  
  const move = ev => {
    isDragging = true;
    els.bubble.style.left = (ev.clientX - offset.x) + 'px';
    els.bubble.style.top = (ev.clientY - offset.y) + 'px';
    els.bubble.style.right = 'auto'; els.bubble.style.bottom = 'auto';
  };
  
  document.addEventListener('mousemove', move);
  document.addEventListener('mouseup', () => {
    document.removeEventListener('mousemove', move);
    // N·∫øu k√©o th·∫£ th√¨ kh√¥ng t√≠nh l√† click
    if(isDragging) {
        // Reset click handler t·∫°m th·ªùi ƒë·ªÉ tr√°nh trigger stopLearning
        const oldClick = els.bubble.onclick;
        els.bubble.onclick = null;
        setTimeout(() => els.bubble.onclick = oldClick, 100);
    }
  }, {once: true});
});

// L∆∞u/T·∫£i tr·∫°ng th√°i
function saveState() {
  const state = {
    words, currentIndex, 
    settings: {
      fontSize: document.getElementById('fontSize').value,
      count: document.getElementById('wordCount').value,
      time: document.getElementById('timePerGroup').value
    }
  };
  localStorage.setItem('vocabState', JSON.stringify(state));
}

function loadState() {
  const raw = localStorage.getItem('vocabState');
  if(raw) {
    const data = JSON.parse(raw);
    if(data.words && data.words.length) {
      words = data.words;
      currentIndex = data.currentIndex || 0;
      els.slider.max = words.length - 1;
      els.slider.value = currentIndex;
      els.slider.disabled = false;
      els.display.innerHTML = `üìÇ ƒê√£ kh√¥i ph·ª•c phi√™n tr∆∞·ªõc.<br>V·ªã tr√≠: <b>${currentIndex}</b> / ${words.length}`;
    }
    if(data.settings) {
      document.getElementById('fontSize').value = data.settings.fontSize || 1.5;
      els.display.style.fontSize = (data.settings.fontSize || 1.5) + 'em';
      document.getElementById('wordCount').value = data.settings.count || 5;
      document.getElementById('timePerGroup').value = data.settings.time || 3;
    }
  }
}

function clearProgress() {
  if(confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu h·ªçc?")) {
    localStorage.removeItem('vocabState');
    location.reload();
  }
}

// Init
window.addEventListener('load', () => {
    loadState();
    // T·ª± ƒë·ªông scroll nh·∫π ƒë·ªÉ ·∫©n thanh ƒë·ªãa ch·ªâ tr√™n mobile
    setTimeout(() => window.scrollTo(0, 1), 100);
});

</script>
</body>
</html>
